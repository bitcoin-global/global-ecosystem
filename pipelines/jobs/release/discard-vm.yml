---
### Resource overrides
meta_plan:
  discard-config: &discard-config
    image: builder
    timeout: 20m
    privileged: true
    <: (( inject meta.release-params ))

  discard-vm:
    - (( grab meta.configure_gcloud ))
    - |
      # Destroy Builder VM
      bitcoin-infra/scripts/remove-vm.sh \
        --name="$BUILDER_VM_NAME" \
        --zone="$BUILDER_VM_ZONE"
        # We won't destroy it for now, just shutdown
        # --destroy

### Pipeline config
jobs:
- name: deprovision-build-vm
  build_logs_to_retain: 3
  serial: true
  plan:
  - in_parallel:
    - get: bitcoin-global
      passed: [build-releases]
      trigger: true
    - get: builder
      passed: [build-releases]
    - get: bitcoin-infra
      passed: [build-releases]

  - task: Discard VM
    <<: *discard-config
    config:
      platform: linux
      inputs:
        - name: builder
        - name: bitcoin-infra
      run:
        user: root
        path: bash
        args:
          - -exc
          - (( join "\n" meta_plan.discard-vm ))
