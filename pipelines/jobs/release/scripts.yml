---
meta:
  get_btg_version: &get_btg_version |
    ### Get Bitcoin Global commited tag to build
    TEMP_TAG=$(grep -e "$(cat ./bitcoin-global/.git/HEAD)" ./bitcoin-global/.git/packed-refs | head -n1 | cut -d ' ' -f 2)
    export GITHUB_TAG=${TEMP_TAG##*/}
    export BITGLOBAL_VERSION=$(echo "$GITHUB_TAG" | cut -f1 -d"-")

  import_gpg: &import_gpg |
    ### Import and unlock GPG key
    echo "TEMP" > ~/temp.txt
    mkdir -p ~/.gpg
    echo "${RELEASE_CERT}" > ~/.gpg/cert.pem
    echo "${RELEASE_KEY}" > ~/.gpg/cert_key.pem
    echo "${GPG_PUBLIC}" | base64 -d > ~/.gpg/public.key
    echo "${GPG_PRIVATE}" | base64 -d > ~/.gpg/private.key
    echo "${GPG_SUBKEY}" | base64 -d > ~/.gpg/sub.key
    gpg --import ~/.gpg/public.key
    gpg --import ~/.gpg/private.key
    gpg --import ~/.gpg/sub.key
    rm -rf ~/temp*

  prepare_MACHINE: &prepare_MACHINE |
    ### Download system dependencies
    echo "Prepare machine"
    apt-get update
    apt-get upgrade -y
    apt-get install -y \
      gnupg2 ca-certificates git software-properties-common \
      python3.6 sudo nano apt-cacher-ng ruby make wget curl pigz \
      build-essential autoconf libssl1.0-dev
    service apt-cacher-ng restart

    ### Install monitoring
    echo "Install monitoring"
    if [ ! -f /opt/netdata/usr/bin/netdata-claim.sh ]; then
      bash <(curl -Ss https://my-netdata.io/kickstart-static64.sh) --dont-wait --no-updates --stable-channel --disable-telemetry
    fi
    /opt/netdata/usr/bin/netdata-claim.sh -token=${NETDATA_INFRA_TOKEN} -rooms=${NETDATA_INFRA_ROOM} -url=https://app.netdata.cloud

    ### Install OSSLSIGNCODE
    mkdir ~/tmp-tools && cd ~/tmp-tools
    wget https://downloads.sourceforge.net/project/osslsigncode/osslsigncode/osslsigncode-1.7.1.tar.gz
    wget https://bitcoincore.org/cfields/osslsigncode-Backports-to-1.7.1.patch
    
    tar xf osslsigncode-1.7.1.tar.gz
    cd osslsigncode-1.7.1
    patch -p1 < ../osslsigncode-Backports-to-1.7.1.patch
    ./configure --without-gsf --without-curl --disable-dependency-tracking
    make && make install
    cd ~/tmp-tools/

    ### Install GHR
    wget https://github.com/tcnksm/ghr/releases/download/v0.13.0/ghr_v0.13.0_linux_amd64.tar.gz -O ghr.tar.gz
    tar xzf ghr.tar.gz
    mv ghr_v0.13.0_linux_amd64/ghr /usr/bin/ghr
    rm -r ghr.tar.gz ghr_v0.13.0_linux_amd64/

    ### Back to path
    cd ~/

  gitian_dependencies: &gitian_dependencies |
    ### Download dependencies
    mkdir -p ./gitian-builder/inputs
    curl -L https://github.com/phracker/MacOSX-SDKs/releases/download/10.13/MacOSX10.11.sdk.tar.xz \
      --output ./gitian-builder/inputs/MacOSX10.11.sdk.tar.gz

  release_setup: &release_setup |
    echo "Setup release build configuration for $GITHUB_TAG"
    
    ### Configure Bitcoin Global builder
    git clone https://github.com/bitcoin-global/bitcoin-global.git ./tmp-bitcoin-global
    cp ./bitcoin-global/contrib/gitian-build.py ./gitian-build.py
    chmod u+x ./gitian-build.py
    rm -rf ./tmp-bitcoin-global

    ### Run builder setup
    rm -rf ./gitian-builder
    ./gitian-build.py --commit --setup fhivemind $GITHUB_TAG

  release_build: &release_build |
    ### Build releases
    ./gitian-build.py -o $RELEASE_TYPE --commit -j $BUILDER_CPUS -m $BUILDER_RAM_MEMORY -b fhivemind $GITHUB_TAG
    
  make_builder: &make_builder |
    ### Deploy Builder VM on GCP
    global-ecosystem/scripts/add-vm.sh \
      --name="$MACHINE_NAME" \
      --zone="$MACHINE_ZONE" \
      --size="$MACHINE_SIZE" \
      --disk-size="$MACHINE_DISK_SIZE" \
      --disk-type="$MACHINE_DISK_TYPE"

  wait_for_builder: &wait_for_builder |
    ### Wait until Build VM stable
    echo "Waiting until VM operational..."
    counter=0
    until gcloud beta compute ssh --zone $MACHINE_ZONE $MACHINE_NAME --project $GCP_PROJECT --command 'echo'; do
        counter=$((counter+1))
        if [[ "$counter" -gt 120 ]]; then
            echo "Timed out!"
            exit 1
        fi
        sleep 1
    done
    echo "Success!"

  setup_builder: &setup_builder
    - gcloud beta compute ssh --zone $MACHINE_ZONE $MACHINE_NAME --project $GCP_PROJECT <<ENDSSH
    - (( grab meta.prepare_MACHINE ))
    - (( grab meta.configure_git ))
    - (( grab meta.import_gpg ))
    - (( grab meta.release_setup ))
    - (( grab meta.gitian_dependencies ))
    - shutdown --reboot 1 && exit
    - ENDSSH

  builder_release: &builder_release
    - gcloud beta compute ssh --zone $MACHINE_ZONE $MACHINE_NAME --project $GCP_PROJECT <<ENDSSH
    - (( grab meta.configure_git ))
    - (( grab meta.import_gpg ))
    - (( grab meta.release_build ))
    - exit
    - ENDSSH

  builder_publish: &builder_publish
    - gcloud beta compute ssh --zone $MACHINE_ZONE $MACHINE_NAME --project $GCP_PROJECT <<ENDSSH
    - (( grab meta.configure_git ))
    - (( grab meta.import_gpg ))
    - (( grab meta.publish_releases ))
    - exit
    - ENDSSH

  builder_stop: &builder_stop |
    global-ecosystem/scripts/remove-vm.sh \
      --name="$MACHINE_NAME" \
      --zone="$MACHINE_ZONE"

  builder_destroy: &builder_destroy |
    global-ecosystem/scripts/remove-vm.sh \
      --name="$MACHINE_NAME" \
      --zone="$MACHINE_ZONE"
      # We won't destroy it for now, just shutdown
      # --destroy

  publish_releases: &publish_releases |
      ############################################################################################
      ### Sign Windows
      tar xf ~/gitian-builder/inputs/bitcoin-global-$BITGLOBAL_VERSION-win-unsigned.tar.gz \
          -C ~/bitcoin-binaries/$GITHUB_TAG
      mv ~/bitcoin-binaries/$GITHUB_TAG/unsigned/* ~/bitcoin-binaries/$GITHUB_TAG/
      rm -rf ~/bitcoin-binaries/$GITHUB_TAG/unsigned/ \
             ~/bitcoin-binaries/$GITHUB_TAG/win-codesign.cert \
             ~/bitcoin-binaries/$GITHUB_TAG/detached-sig-create.sh

      osslsigncode sign -certs ~/.gpg/cert.pem -key ~/.gpg/cert_key.pem \
        -n "Bitcoin Global $GITHUB_TAG" -i http://bitcoin-global.io/ \
        -in ~/bitcoin-binaries/$GITHUB_TAG/bitcoin-global-$BITGLOBAL_VERSION-win64-setup-unsigned.exe \
        -out ~/bitcoin-binaries/$GITHUB_TAG/bitcoin-global-$BITGLOBAL_VERSION-win64-setup.exe
      rm -rf ~/bitcoin-binaries/$GITHUB_TAG/bitcoin-global-$BITGLOBAL_VERSION-win64-setup-unsigned.exe

      ### Sign OSX
      mv ~/bitcoin-binaries/$GITHUB_TAG/bitcoin-global-$BITGLOBAL_VERSION-osx-unsigned.dmg \
         ~/bitcoin-binaries/$GITHUB_TAG/bitcoin-global-$BITGLOBAL_VERSION-osx.dmg || echo "OSX already present"

      ### Add Win to detached sigs
      mkdir -p ~/global.detached.sigs/win/
      osslsigncode extract-signature -pem \
        -in ~/bitcoin-binaries/$GITHUB_TAG/bitcoin-global-$BITGLOBAL_VERSION-win64-setup.exe \
        -out ~/global.detached.sigs/win/bitcoin-global-$BITGLOBAL_VERSION-win64-setup.exe.pem

      ### Add OSX to detached sigs
      # empty for now...

      ### Push detached signatures
      cd ~/global.detached.sigs
      git add .
      git checkout -B $GITHUB_TAG
      git commit -m "cd: Add $GITHUB_TAG detached sigs"
      if [[ "$UPLOAD_RELEASE_CONFIGS" == "true" ]]; then
        git push --set-upstream origin $GITHUB_TAG || git push
      fi

      ### Push regular signatures
      cd ~/global.gitian.sigs
      if [[ "$UPLOAD_RELEASE_CONFIGS" == "true" ]]; then
        git push
      fi

      ### Remove debug packages
      rm -rf ~/bitcoin-binaries/$GITHUB_TAG/*debug*

      ### Complete signing
      cd ~/bitcoin-binaries/$GITHUB_TAG
      shasum -a 256 bitcoin-global-* > SHA256SUMS
      gpg2 --pinentry-mode loopback --yes --clearsign --output SHA256SUMS.asc --sign SHA256SUMS
      rm -rf SHA256SUMS

      ############################################################################################
      ### Generate release report
      LAST_COMMIT=\$(git --git-dir ~/bitcoin-global/.git rev-list --ancestry-path 58ba7c314d552cea8cb024960a8504577aee586f..HEAD | tail -1)
      FROM_COMMIT=\$(git --git-dir ~/bitcoin-global/.git describe --tags --abbrev=0 || echo \$LAST_COMMIT)
      RELEASE_DATA=\$(git --git-dir ~/bitcoin-global/.git log \$FROM_COMMIT..HEAD --no-merges \
                  --pretty=format:'* **[\`%h\`](https://github.com/bitcoin-global/bitcoin-global/commit/%H)**  %s' \
                  -i -E --grep=".*: .*")
      COMMITTERS=\$(git --git-dir ~/bitcoin-global/.git log --format="* %an" \$FROM_COMMIT..HEAD | sort | uniq | grep -i -E -v "bitcoin-global-bot" )
      DATE=\$(date '+%Y-%m-%d')

      echo -e "## Release v$GITHUB_TAG (\$DATE)\n\n" > release.md
      echo -e "### :globe_with_meridians: Getting started\n" >> release.md
      echo -e "* [Download Bitcoin Global](https://github.com/bitcoin-global/bitcoin-global/releases/tag/$GITHUB_TAG)" >> release.md
      echo -e "* [Install Bitcoin Global](https://bitcoin-global.io/getting-started)" >> release.md
      echo -e "* [Requirements](https://bitcoin-global.io/getting-started#requirements)" >> release.md
      echo -e "* [Release notes](https://github.com/bitcoin-global/bitcoin-global/tree/master/doc/release-notes)\n\n---\n\n" >> release.md
      echo -e "### :checkered_flag: Release notes:\n \$RELEASE_DATA\n\n" >> release.md
      echo -e "### :busts_in_silhouette: Committers:\n \$COMMITTERS\n\n---" >> release.md
      cp release.md ~/tmp-tools/release-short.md
      echo -e '### :link: Release hashes and signatures\n\n\`\`\`gpg' >> release.md
      cat ./SHA256SUMS.asc >> release.md
      echo -e '\`\`\`\n\nSigned by public key \`DC17 1097 7C99 4CF2 DD8A 59DA 9791 24CB 5F7F BF39\` (<fhivemind@users.noreply.github.com>)' >> release.md
      mv ./release.md ~/tmp-tools/release.md

      ### Publish
      ghr -t ${GITHUB_TOKEN} -u bitcoin-global -r bitcoin-global -n v$GITHUB_TAG -b "\$(cat ~/tmp-tools/release.md)" -delete v$GITHUB_TAG .

      ### Upload release notes
      cd ~/bitcoin-global
      git checkout master && git fetch && git pull
      cp ~/tmp-tools/release-short.md ./doc/release-notes/release-notes-$GITHUB_TAG.md && git add ./doc/release-notes/release-notes-$GITHUB_TAG.md
      git diff-index --quiet HEAD || git commit -m "[docs] Adding release notes for $GITHUB_TAG"
      
      # if [[ "$UPLOAD_RELEASE_CONFIGS" == "true" ]]; then
      #   git push
      # fi
