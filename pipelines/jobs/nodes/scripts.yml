---
meta:
  push-trigger: &push-trigger |
    ### Get timestamp
    timestamp=$(date '+%d/%m/%Y %H:%M:%S')

    ### Add trigger details
    git clone -b $GIT_BRANCH $GIT_REPO $GIT_FOLDER && cd $GIT_FOLDER
    echo "\`$TRIGGER_OPERATION-$TRIGGER_NET\` | \`$timestamp\`" >> TRIGGERS.md

    ### Sync changes
    git fetch && git pull
    git add .
    git commit -m "$COMMIT_MESSAGE"

  update_nodelist: &update_nodelist |
    ### Get timestamp
    timestamp=$(date '+%d/%m/%Y %H:%M:%S')
    
    ### Update nodelist data
    cd ./global-nodes
    echo "Updating node list"
    echo "Instance name | Public IP address | ElectrumX | Explorer | Status" > $SAVE_FILE
    echo "--- | --- | ---" >> $SAVE_FILE

    for VM_ZONE in $(echo ${NODE_ZONES} | sed "s/,/ /g")
    do
      VM_REGION=${VM_ZONE:0:-2}
      VM_DATA=$(gcloud beta compute instances describe $TRIGGER_NET--$VM_ZONE-global-node --zone $VM_ZONE --format json)
      name=$(echo ${VM_DATA} | jq .name | tr -d '"')
      public_ip=$(echo ${VM_DATA} | jq .networkInterfaces[0].accessConfigs[0].natIP | tr -d '"')
      status=$(echo ${VM_DATA} | jq .status | tr -d '"')
      DATA="\`$name\`"
      DATA="$DATA | [$public_ip]($public_ip)"
      DATA="$DATA | [http://electrumx.${VM_REGION}.${BITCOIN_NETWORK_TYPE}net.bitcoin-global.io](http://electrumx.${VM_REGION}.${BITCOIN_NETWORK_TYPE}net.bitcoin-global.io)"
      DATA="$DATA | [http://explorer.${VM_REGION}.${BITCOIN_NETWORK_TYPE}net.bitcoin-global.io:50001](http://explorer.${VM_REGION}.${BITCOIN_NETWORK_TYPE}net.bitcoin-global.io:50001)"
      DATA="$DATA | $status"
      echo "$DATA" >> $SAVE_FILE
    done
    echo -e "\n\nLast update: \`$timestamp\`" >> $SAVE_FILE

    # Sync changes
    git fetch && git pull
    git add .
    git commit -m "$COMMIT_MESSAGE"
