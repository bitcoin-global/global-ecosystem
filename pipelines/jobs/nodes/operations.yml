---
meta:
  # Git and GCloud already configured for each operation
  perform_deploy: &perform_deploy
  - (( grab meta.make_node ))
  - (( grab meta.wait_for_node ))
  - (( join "\n" meta.install_node ))
  # - (( grab meta.stop_node ))

  perform_destroy: &perform_destroy
  - (( grab meta.destroy_node ))

  perform_stop: &perform_stop
  - (( grab meta.stop_node ))

  perform_update: &perform_update
  - (( grab meta.make_node ))     # Ensures its online
  - (( grab meta.wait_for_node ))
  - (( join "\n" meta.update_node ))
  # - (( grab meta.stop_node ))

  prepare_node: &prepare_node |
    ### Install required packages
    echo "Prepare machine"
    apt-get update
    apt-get install -y \
      gnupg2 ca-certificates git software-properties-common \
      python3.6 sudo nano ruby wget curl pigz \
      autoconf libssl1.0-dev dirmngr gosu dnsutils gpg wget jq npm
    service apt-cacher-ng restart

    ### Install monitoring
    echo "Install monitoring"
    bash <(curl -Ss https://my-netdata.io/kickstart-static64.sh) --dont-wait --no-updates --stable-channel --disable-telemetry
    /opt/netdata/usr/bin/netdata-claim.sh -token=${NETDATA_INFRA_TOKEN} -rooms=${NETDATA_INFRA_ROOM} -url=https://app.netdata.cloud

  post_git_ops: &post_git_ops |
    ### Install required tools
    mkdir -p /binaries
    mkdir -p /bitcoin-global
    rm -rf ./global-ecosystem
    git clone ${GIT_REPO_ECOSYSTEM} ./global-ecosystem
    chmod +x ./global-ecosystem/src/bitglobal/install-node.sh

  post_operations: &post_operations |
    ### Install blockchain explorer
    cd ~/
    rm -rf ./explorer
    git clone ${GIT_REPO_EXPLORER} ./explorer && cd ./explorer
    npm install
    nohup node bin/cli.js --host 0.0.0.0 --port 5000 \
      --bitglobd-port 18444 \
      --bitglobd-user ${BITCOIN_RPC_USERNAME} \
      --bitglobd-pass ${BITCOIN_RPC_PASSWORD} \
    > ./explorer.log 2>&1 &

  make_node: &make_node |
    ### Deploy Node VM on GCP
    global-ecosystem/scripts/add-vm.sh \
      --name="$NODE_NAME" \
      --zone="$NODE_ZONE" \
      --size="$NODE_SIZE" \
      --disk-size="$NODE_DISK_SIZE" \
      --disk-type="$NODE_DISK_TYPE" \
      --tags="bitcoin-global,bitcoin-$NODE_TYPE" \
      --static-ip

  wait_for_node: &wait_for_node |
    ### Loop until ready
    echo "Waiting until VM operational..."
    counter=0
    until gcloud beta compute ssh --zone $NODE_ZONE $NODE_NAME --project $GCP_PROJECT --command 'echo'; do
        counter=$((counter+1))
        if [[ "$counter" -gt 120 ]]; then
            echo "Timed out!"
            exit 1
        fi
        sleep 1
    done
    echo "Success!"

  install_bitcoin: &install_bitcoin |
    ### Installing Bitcoin Global
    ./global-ecosystem/src/bitglobal/install-node.sh \
      -v ${BITCOIN_VERSION} -r ${BITCOIN_RELEASE} \
      -t /binaries -d ${BITCOIN_DATA_DIR}

  update_bitcoin: &update_bitcoin |
    ### Updating Bitcoin Global
    ./global-ecosystem/src/bitglobal/install-node.sh \
      -v ${BITCOIN_VERSION} -r ${BITCOIN_RELEASE} \
      -t /binaries -d ${BITCOIN_DATA_DIR}

  run_bitcoin: &run_bitcoin |
    ### Stop Bitcoin Global
    /binaries/bin/bitglob-cli stop || echo "mainnet: Already shutdown"
    /binaries/bin/bitglob-cli -testnet stop || echo "testnet: Already shutdown"
    sleep 1m

    ### Run Bitcoin Global
    /binaries/bin/bitglobd -conf=/binaries/.bitglobal/bitglob.conf $BITCOIN_ENTRYPOINT

  install_node: &install_node
    - gcloud beta compute ssh --zone $NODE_ZONE $NODE_NAME --project $GCP_PROJECT << EOF
    - (( grab meta.prepare_node ))
    - (( grab meta.configure_git ))
    - (( grab meta.post_git_ops ))
    - (( grab meta.install_bitcoin ))
    - (( grab meta.generate_env_config ))
    - (( grab meta.run_bitcoin ))
    - (( grab meta.post_operations ))
    - exit
    - EOF

  update_node: &update_node
    - gcloud beta compute ssh --zone $NODE_ZONE $NODE_NAME --project $GCP_PROJECT << EOF
    - (( grab meta.prepare_node ))
    - (( grab meta.configure_git ))
    - (( grab meta.post_git_ops ))
    - (( grab meta.update_bitcoin ))
    - (( grab meta.generate_env_config ))
    - (( grab meta.run_bitcoin ))
    - (( grab meta.post_operations ))
    - exit
    - EOF

  stop_node: &stop_node |
    ### Stop node
    ./global-ecosystem/scripts/remove-vm.sh \
      --name="$NODE_NAME" \
      --zone="$NODE_ZONE"

  destroy_node: &destroy_node |
    ### Destroy node
    ./global-ecosystem/scripts/remove-vm.sh \
      --name="$NODE_NAME" \
      --zone="$NODE_ZONE" \
      --destroy

  generate_env_config: &generate_env_config |
    ### =============================
    ### BITGLOB CONFIGURATION
    cat <<CONFIG > /binaries/.bitglobal/bitglob.conf
    listen=1
    maxconnections=64
    upnp=1
    txindex=1

    dbcache=64
    par=2
    checkblocks=24
    checklevel=0

    disablewallet=1
    datadir=${BITCOIN_DATA_DIR}

    rpcallowip=127.0.0.1
    rpcuser=${BITCOIN_RPC_USERNAME}
    rpcpassword=${BITCOIN_RPC_PASSWORD}

    [${BITCOIN_NETWORK_TYPE}]
    port=${BITCOIN_PORT}
    bind=0.0.0.0
    rpcbind=127.0.0.1
    rpcport=18444
    CONFIG

    ### =============================
    ### BITGLOB SERVICE CONFIGURATION
    cat <<SCRIPT > /binaries/bin/startup-script.sh
    #!/bin/bash
    export GITHUB_TOKEN=${GITHUB_TOKEN}
    /binaries/bin/bitglobd -conf=/binaries/.bitglobal/bitglob.conf $BITCOIN_ENTRYPOINT
    SCRIPT

    cat <<SERVICE > /etc/systemd/system/bitcoin_global.service
    [Unit]
    Description=Bitcoin Global script

    [Service]
    ExecStart=/binaries/bin/startup-script.sh

    [Install]
    WantedBy=multi-user.target
    SERVICE

    chmod +x /binaries/bin/startup-script.sh
    systemctl enable bitcoin_global
